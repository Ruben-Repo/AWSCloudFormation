{
  "AWSTemplateFormatVersion" : "2010-09-09",

    "Description" : "Creates an autoscaling group.",

      "Parameters" : {
          "InstanceType" : {
                "Description" : "AppServer EC2 instance type",
                      "Type" : "String",
                            "Default" : "t2.micro",
                                  "AllowedValues" : [ "t2.micro", "t2.small", "t2.medium", "m1.small", "m1.medium", "m1.large", "m1.xlarge", "m2.xlarge", "m2.2xlarge", "m2.4xlarge", "m3.medium", "m3.large", "m3.xlarge", "m3.2xlarge", "c1.medium", "c1.xlarge", "c3.large", "c3.xlarge", "c3.2xlarge", "c3.4xlarge", "c3.8xlarge", "g2.2xlarge", "r3.large", "r3.xlarge", "r3.2xlarge", "r3.4xlarge", "r3.8xlarge", "i2.xlarge", "i2.2xlarge", "i2.4xlarge", "i2.8xlarge", "hi1.4xlarge", "hs1.8xlarge", "cr1.8xlarge", "cc2.8xlarge", "cg1.4xlarge" ]
                                  ,
                                        "ConstraintDescription" : "Must be a valid EC2 instance type."
                                            },
                                                "KeyName" : {
                                                      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the instances",
                                                            "Type" : "AWS::EC2::KeyPair::KeyName",
                                                                  "ConstraintDescription" : "must be the name of an existing EC2 KeyPair."
                                                                      },
                                                                          "InstanceSecurityGroup" : {
                                                                                "Description" : "Security Group for the instances.",
                                                                                      "Type" : "AWS::EC2::SecurityGroup::Id",
                                                                                            "Default": "sg-******"
                                                                                                },
                                                                                                    "ServiceELB" : {
                                                                                                          "Description" : "LoadBalancer to attach the instances to.",
                                                                                                                "Type" : "String"
                                                                                                                    },
                                                                                                                        "InstanceAvailabilityZones" : {
                                                                                                                              "Description" : "A list of avilability zones in which instances will be launched. ",
                                                                                                                                    "Type" : "CommaDelimitedList",
                                                                                                                                          "Default" : "us-east-1b,us-east-1d"
                                                                                                                                              },
                                                                                                                                                  "ASGDesiredCapacity" : {
                                                                                                                                                        "Description" : "The desired capacity for the Auto Scaling group",
                                                                                                                                                              "Default" : "2",
                                                                                                                                                                    "Type" : "Number"
                                                                                                                                                                        },
                                                                                                                                                                            "ASGHealthCheckGracePeriod" : {
                                                                                                                                                                                  "Description" : "The length of time in seconds after a new EC2 instance comes into service that Auto Scaling starts checking its health.",
                                                                                                                                                                                        "Default" : "600",
                                                                                                                                                                                              "Type" : "Number"
                                                                                                                                                                                                  },
                                                                                                                                                                                                      "ASGHealthCheckType": {
                                                                                                                                                                                                            "Description" : "The service you want the health status from, Amazon EC2 or Elastic Load Balancer. Valid values are EC2 or ELB.",
                                                                                                                                                                                                                  "Default" : "ELB",
                                                                                                                                                                                                                        "Type" : "String",
                                                                                                                                                                                                                              "AllowedValues" : [ "ELB", "EC2" ]
                                                                                                                                                                                                                                  },
                                                                                                                                                                                                                                      "ASGMinSize" : {
                                                                                                                                                                                                                                            "Description" : "The minimum size of the Auto Scaling group.",
                                                                                                                                                                                                                                                  "Type" : "Number",
                                                                                                                                                                                                                                                        "Default" : "2"
                                                                                                                                                                                                                                                            },
                                                                                                                                                                                                                                                                "ASGMaxSize" : {
                                                                                                                                                                                                                                                                      "Description" : "The maximum size of the Auto Scaling group.",
                                                                                                                                                                                                                                                                            "Type" : "Number",
                                                                                                                                                                                                                                                                                  "Default" : "10"
                                                                                                                                                                                                                                                                                      },
                                                                                                                                                                                                                                                                                          "InstanceSubnets" : {
                                                                                                                                                                                                                                                                                                "Description" : "A list of subnet identifiers of Amazon Virtual Private Cloud (Amazon VPCs). The subnets that you specify for VPCZoneIdentifier must reside in the Availability Zones that you specify with the AvailabilityZones parameter.",
                                                                                                                                                                                                                                                                                                      "Default" : "subnet-******,subnet-******",
                                                                                                                                                                                                                                                                                                            "Type" : "List<AWS::EC2::Subnet::Id>"
                                                                                                                                                                                                                                                                                                                },
                                                                                                                                                                                                                                                                                                                    "InstanceAMI" : {
                                                                                                                                                                                                                                                                                                                          "Description" : "AMI to use for instances.",
                                                                                                                                                                                                                                                                                                                                "Default" : "ami-c1e699d7",
                                                                                                                                                                                                                                                                                                                                      "Type" : "String"
                                                                                                                                                                                                                                                                                                                                          },
                                                                                                                                                                                                                                                                                                                                              "Environment" : {
                                                                                                                                                                                                                                                                                                                                                    "Description" : "Instance Environment.",
                                                                                                                                                                                                                                                                                                                                                          "Default" : "uat2",
                                                                                                                                                                                                                                                                                                                                                                "Type" : "String"
                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                      },

                                                                                                                                                                                                                                                                                                                                                                        "Mappings" : {
                                                                                                                                                                                                                                                                                                                                                                          },

                                                                                                                                                                                                                                                                                                                                                                            "Resources" : {
                                                                                                                                                                                                                                                                                                                                                                                "AppServerGroup" : {
                                                                                                                                                                                                                                                                                                                                                                                      "Type" : "AWS::AutoScaling::AutoScalingGroup",
                                                                                                                                                                                                                                                                                                                                                                                            "Properties" : {
                                                                                                                                                                                                                                                                                                                                                                                                    "AvailabilityZones" : { "Ref" : "InstanceAvailabilityZones" },
                                                                                                                                                                                                                                                                                                                                                                                                            "DesiredCapacity" : { "Ref" : "ASGDesiredCapacity" },
                                                                                                                                                                                                                                                                                                                                                                                                                    "HealthCheckGracePeriod" : { "Ref" : "ASGHealthCheckGracePeriod" },
                                                                                                                                                                                                                                                                                                                                                                                                                            "HealthCheckType" : { "Ref" : "ASGHealthCheckType" },
                                                                                                                                                                                                                                                                                                                                                                                                                                    "LaunchConfigurationName" : { "Ref" : "LaunchConfig" },
                                                                                                                                                                                                                                                                                                                                                                                                                                            "MinSize" : { "Ref" : "ASGMinSize" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                    "MaxSize" : { "Ref" : "ASGMaxSize" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                            "LoadBalancerNames" : [ { "Ref" : "ServiceELB" } ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    "VPCZoneIdentifier" : { "Ref" : "InstanceSubnets" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            "Tags" : [ { "Key" : "Environment", "Value" : { "Ref" : "Environment" }, "PropagateAtLaunch" : "true" } ,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               { "Key" : "CreatedBy", "Value" : "CloudFormation", "PropagateAtLaunch" : "true" }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 ],

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "LaunchConfig": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Type": "AWS::AutoScaling::LaunchConfiguration",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Properties": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "KeyName": { "Ref": "KeyName" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "ImageId": { "Ref" : "InstanceAMI" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "InstanceType": { "Ref": "InstanceType" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "SecurityGroups": [ { "Ref": "InstanceSecurityGroup" } ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         },

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "AppServerScaleUpPolicy" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Type" : "AWS::AutoScaling::ScalingPolicy",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "Properties" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "AdjustmentType" : "ChangeInCapacity",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "AutoScalingGroupName" : { "Ref" : "AppServerGroup" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Cooldown" : "60",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "ScalingAdjustment" : "1"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "AppServerScaleDownPolicy" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "Type" : "AWS::AutoScaling::ScalingPolicy",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Properties" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "AdjustmentType" : "ChangeInCapacity",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "AutoScalingGroupName" : { "Ref" : "AppServerGroup" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "Cooldown" : "60",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "ScalingAdjustment" : "-1"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             },

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "CPUAlarmHigh": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      "Type": "AWS::CloudWatch::Alarm",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "Properties": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "AlarmDescription": "Scale-up if CPU > 90% for 10 minutes",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "MetricName": "CPUUtilization",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Namespace": "AWS/EC2",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "Statistic": "Average",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Period": "300",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "EvaluationPeriods": "2",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Threshold": "90",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "AlarmActions": [ { "Ref": "AppServerScaleUpPolicy" } ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Dimensions": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "Name": "AutoScalingGroupName",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Value": { "Ref": "AppServerGroup" }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "ComparisonOperator": "GreaterThanThreshold"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "CPUAlarmLow": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  "Type": "AWS::CloudWatch::Alarm",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Properties": {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "AlarmDescription": "Scale-down if CPU < 50% for 10 minutes",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "MetricName": "CPUUtilization",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Namespace": "AWS/EC2",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Statistic": "Average",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Period": "300",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "EvaluationPeriods": "2",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Threshold": "50",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "AlarmActions": [ { "Ref": "AppServerScaleDownPolicy" } ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               "Dimensions": [
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "Name": "AutoScalingGroupName",
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Value": { "Ref": "AppServerGroup" }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   ],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "ComparisonOperator": "LessThanThreshold"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       },

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "Outputs" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "AutoScalingGroupName" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   "Value" : { "Ref": "AppServerGroup" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         "Description" : "AutoScaling Group Name."
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "ScaleUpAlarm" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       "Value" : { "Ref" : "CPUAlarmHigh" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             "Description" : "Scale Up Alarm"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     "ScaleDownAlarm" : {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           "Value" : { "Ref" : "CPUAlarmLow" },
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 "Description" : "Scale Down Alarm"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       }
